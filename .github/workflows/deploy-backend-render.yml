name: Deploy Backend to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy-to-render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Trigger Render deploy via API
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          if [ -z "$RENDER_SERVICE_ID" ] || [ -z "$RENDER_API_KEY" ]; then
            echo "Missing RENDER_SERVICE_ID or RENDER_API_KEY. Set them in repository Settings â†’ Secrets."
            exit 1
          fi

          echo "Creating deploy for service $RENDER_SERVICE_ID..."
          RES=$(curl -s -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" -H "Content-Type: application/json" -d '{}')
          echo "$RES" > /tmp/render-deploy-response.json
          DEPLOY_ID=$(echo "$RES" | jq -r .id)
          if [ -z "$DEPLOY_ID" ] || [ "$DEPLOY_ID" = "null" ]; then
            echo "Failed to create deploy:"
            cat /tmp/render-deploy-response.json
            exit 1
          fi
          echo "Deploy created: $DEPLOY_ID"

          # Poll for deploy status
          for i in $(seq 1 60); do
            S=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$DEPLOY_ID")
            STATE=$(echo "$S" | jq -r .state)
            echo "[$i] state=$STATE"
            if [ "$STATE" = "success" ]; then
              echo "Deploy succeeded"
              exit 0
            fi
            if [ "$STATE" = "failed" ]; then
              echo "Deploy failed"
              echo "$S"
              exit 1
            fi
            sleep 5
          done

          echo "Timeout waiting for deploy to finish"
          exit 1
